#!/bin/bash

cd ../simuc2

meteor build ../ec2  --architecture os.linux.x86_64

cd ../ec2

scp simuc2.tar.gz simuc2:/home/ubuntu

rm simuc2.tar.gz

ssh simuc2 '
sudo chown -R ubuntu:ubuntu ~/.pm2
pm2 delete all
sudo rm -r bundle
tar zxf *.tar.gz
rm *.tar.gz
cd bundle
(cd programs/server && npm install)

cat <<EOT | tee -a app.json
{
  "apps" : [{
    "name"        : "simuc2",
    "script"      : "~/bundle/main.js",
    "env": {
      "MONGO_URL": "mongodb://localhost:27017/simuc2",
      "ROOT_URL": "http://18.231.13.217",
      "PORT": "80"
    }
  }]
}
EOT

pm2 start app.json --node-args="--max-old-space-size=256 --gc_interval=100"
pm2 save
'
